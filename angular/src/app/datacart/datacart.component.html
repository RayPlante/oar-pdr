<style id="antiClickjack">
  body {
    display: none !important;
  }
</style>
<script type="text/javascript">
  if (self === top) {
    var antiClickjack = document.getElementById("antiClickjack");
    if (antiClickjack !== null && antiClickjack !== undefined)
      antiClickjack.parentNode.removeChild(antiClickjack);

  } else {
    top.location = self.location;
  }
</script>

<div style="width: 94%; margin-top: 2em; margin-left: 3%; ">
  <div *ngIf="!isPopup" class="title" style="margin-bottom: 0.5em;">Download Manager</div>
  <div style="display: flex;justify-content: space-between;">
    <div *ngIf="bundlePlanStatus != 'complete' && bundlePlanMessage" style="display: inline; text-align: left;">
      <i class="faa faa-warning" [ngStyle]="{'color':messageColor, 'padding-right':'.5em'}"></i>
      <span *ngIf="bundlePlanStatus == 'error';else no_error"
        [ngStyle]="{'color':messageColor}">{{broadcastMessage}}</span>
      <ng-template #no_error>
        <span [ngStyle]="{'color':getColor(), 'padding-right':'.5em'}">{{broadcastMessage}}</span>
        <span (click)="showMessageBlock = !showMessageBlock">
          <i *ngIf="!showMessageBlock" class="faa faa-arrow-circle-down"
            [ngStyle]="{'color':messageColor,'cursor':'pointer'}" data-toggle="tooltip" title="Show details"></i>
          <i *ngIf="showMessageBlock" class="faa faa-arrow-circle-up faa-1x icon-white"
            [ngStyle]="{'color':messageColor,'cursor':'pointer'}" data-toggle="tooltip" title="Hide details"></i>
        </span>
      </ng-template>
    </div>
    <ngx-spinner bdOpacity=0.9 bdColor="white" size="medium" color="#78c5ff" type="ball-circus" fullScreen="false">
      <p style="font-size: 15px; color: black">{{currentTask}} ...</p>
    </ngx-spinner>
    <!-- <div *ngIf="showCurrentTask" class="app-loading">
      <div class="logo">{{currentTask}}</div>
      <svg class="spinner" viewBox="25 25 50 50">
        <circle class="path" cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"
          style="color:blue" />
      </svg>
    </div> -->
    <!-- <div *ngIf="showCurrentTask" style="display: inline; font-size: 9pt;">
      <i class="faa faa-spinner faa-spin" style="color:#1E6BA1" aria-hidden="true"></i>
      {{currentTask}}
    </div> -->
  </div>
</div>
<div *ngIf="showMessageBlock" style="width: 94%;margin-left: 3%;margin-right: 3%;">
  <table style="width: 100%;margin-bottom: 0.5em;">
    <thead style="background-color:darkorange; margin:0; color:white">
      <tr>
        <th scope="col" style="padding-left:.5em;">
          <span *ngIf="bundlePlanUnhandledFiles" (click)="showMessage = !showMessage">
            <i *ngIf="showMessage; else hideMessage" class="faa faa-arrow-circle-up faa-1x icon-white"
              style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Collapse All"></i>
            <ng-template #hideMessage>
              <i class="faa faa-arrow-circle-down faa-1x icon-white" style="cursor: pointer;color: rgb(255, 255, 255);"
                data-toggle="tooltip" title="Expand All"></i>
            </ng-template>
          </span>
          Message
        </th>
      </tr>
    </thead>
    <tbody *ngIf="showMessage">
      <tr *ngFor="let msg of bundlePlanMessage; let i =index">
        <td style="border-bottom:1pt solid black;">
          {{msg}}
        </td>
      </tr>
    </tbody>
  </table>
  <table *ngIf="bundlePlanUnhandledFiles" style="width: 100%;margin-bottom: 0.5em;">
    <tr style="background-color:darkorange; margin:0; color:white" data-toggle="tooltip" title="Unhandled Files">
      <th style="width: 30%;padding-left:.5em;">
        <span *ngIf="bundlePlanUnhandledFiles" (click)="showUnhandledFiles = !showUnhandledFiles">
          <i *ngIf="showUnhandledFiles; else hideUnhandledFiles" class="faa faa-arrow-circle-up faa-1x icon-white"
            style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Collapse All"></i>
          <ng-template #hideUnhandledFiles>
            <i class="faa faa-arrow-circle-down faa-1x icon-white" style="cursor: pointer;color: rgb(255, 255, 255);"
              data-toggle="tooltip" title="Expand All"></i>
          </ng-template>
        </span>
        File Path
      </th>
      <th style="width: 30%;padding-left:.5em;">Download Url</th>
      <th style="width: 40%;padding-left:.5em;">Detail message</th>
    </tr>
    <tbody *ngIf="showUnhandledFiles">
      <tr *ngFor="let file of bundlePlanUnhandledFiles">
        <td width="30%" style="padding-left:.5em;border-bottom:1pt solid black;">{{file.filePath}}</td>
        <td width="30%" style="padding-left:.5em;border-bottom:1pt solid black;">{{file.downloadUrl}}
        </td>
        <td width="40%" style="padding-left:.5em;border-bottom:1pt solid black;">{{file.message}}</td>
      </tr>
    </tbody>
  </table>
</div>
<div style="width: 94%;margin-left: 3%;margin-right: 3%;margin-bottom:1em;">
  <table *ngIf="zipData.length > 0" style="width: 100%;">
    <tr style="background-color:green; margin:0; color:white" data-toggle="tooltip" title="Unhandled Files">
      <th style="width: 50%;padding-left:.5em;">
        <span (click)="showZipFiles = !showZipFiles">
          <i *ngIf="!showZipFiles" class="faa faa-arrow-circle-down faa-1x icon-white"
            style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Expand All"></i>
          <i *ngIf="showZipFiles" class="faa faa-arrow-circle-up faa-1x icon-white"
            style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Collapse All"></i>
        </span>
        Zip File Name
      </th>
      <th style="width: 50%;padding-left:.5em;">
        Download Status
        <span *ngIf="!allProcessed" class="faa-stack fa-lg" style="cursor: pointer;" (click)="cancelDownloadAll()"
          data-toggle="tooltip" title="Cancel All Downloads">
          <!-- <i class="faa faa-circle-thin faa-stack-1x" aria-hidden="true"></i> -->
          <i class="faa faa-remove faa-stack-1x" aria-hidden="true" style="color: rgb(255, 255, 255);"></i>
        </span>
      </th>
    </tr>
    <tr *ngFor="let zip of zipData">
      <td *ngIf="showZipFiles" style="padding-left:.5em;border-bottom:1pt solid black;">{{zip.fileName}}</td>
      <td *ngIf="showZipFiles" style="padding-left:.5em;border-bottom:1pt solid black;">
        <div style="padding-left: .5em; display:flex;"
          *ngIf="zip.downloadStatus === 'downloading';else not_downloading">
          <div style="padding-left: .5em; flex: 0 0 auto;">
            <span style="display:inline;">
              <p-progressSpinner [style]="{width: '12px', height: '12px'}"></p-progressSpinner>
            </span>
          </div>
          <span style="display:inline;font-size: 0.8em">
            {{zip.downloadStatus}}
          </span>
          <!-- <div style="padding-left: .5em; flex: 0 0 auto;">
            <span style="display:inline;font-size: 0.8em">
              {{zip.downloadProgress}}%
            </span>
          </div>
          <div style="padding-left: 2%; padding-top: 8px;width: 200px;flex: 0 0 auto;height: 2em;">
            <p-progressBar [value]="zip.downloadProgress" showValue="false"></p-progressBar>
          </div> -->
          <div style="padding-left:5px; flex: 0 0 auto;">
            <span (click)="cancelDownloadZip(zip)" style="cursor: pointer;"><i class="faa faa-remove"></i></span>
          </div>
        </div>
        <ng-template #not_downloading>
          <div *ngIf="zip.downloadStatus != 'Error'; else download_error"
            style="padding-left: 2%; width: 200px; display:inline;">
            <i *ngIf="zip.downloadStatus === 'downloaded'" class="faa faa-check" style="margin-top: 8px;"></i>
            <i *ngIf="zip.downloadStatus === 'cancelled'" class="faa faa-remove" style="margin-top: 8px;"></i>
            {{zip.downloadStatus}}
          </div>
          <ng-template #download_error>
            <div style="padding-left: 2%; display:inline;font-size: 0.8em; color: red">
              <i class="faa faa-warning"
                [ngStyle]="{'color':messageColor, 'padding-right':'.5em', 'margin-top':'8px'}"></i>
              {{zip.downloadErrorMessage}}
            </div>
          </ng-template>
          <i *ngIf="zip.downloadStatus != null" class="faa faa-repeat"
            style="padding-left: 2%; display: inline; flex: 0 0 auto;font-size: 0.8em; color: #1E6BA1;"
            data-toggle="tooltip" title="Retry" (click)="downloadOneZip(zip)"></i>
        </ng-template>
      </td>
    </tr>
  </table>
</div>
<div style="padding-left: 3%; padding-right: 3%; width: 100%;margin-bottom:0.5em;text-align: right;">
  <button type="button" (click)="downloadAllFilesFromAPI()" pButton type="submit"
    [ngStyle]="{'margin-right':'1em','width':'max-content','background-color':getButtonColor()}"
    [disabled]="selectedFileCount==0">
    <i class="faa faa-download faa-1x icon-white" style="color: #fff;"></i>
    Download Selected
    <span class="w3-circle button-badge" [ngStyle]="{'color':getButtonColor()}">&nbsp;{{selectedFileCount}}&nbsp;</span>
  </button>

  <button type="button" (click)="removeByDownloadStatus()" pButton type="submit"
    style="margin-right:1em;width:max-content; background-color:grey;" [disabled]="noFileDownloaded">
    <i class="faa faa-trash faa-1x icon-white" style="color: #fff;"></i>
    Remove downloaded
    <span class="w3-circle button-badge"
      [ngStyle]="{'color':getDownloadedColor(),'background-color':getDownloadedBkColor()}">&nbsp;{{totalDownloaded}}&nbsp;</span>
    <!-- <span class="badge badge-pill" [ngStyle]="{'color':getDownloadedColor(), 'background-color':getDownloadedBkColor()}">{{totalDownloaded}}</span> -->
  </button>

  <button type="button" (click)="removeByDataId()" pButton type="submit"
    style="width:max-content; background-color:grey;" [disabled]="selectedFileCount==0">
    <i class="faa faa-trash faa-1x icon-white" style="color: #fff;"></i>
    Remove selected
    <span class="w3-circle button-badge" [ngStyle]="{'color':'grey'}">&nbsp;{{selectedFileCount}}&nbsp;</span>
    <!-- <span class="badge badge-pill" style="color:grey; background-color:white;">{{selectedFileCount}}</span> -->
  </button>
</div>
<div>
  <!-- <p-treeTable *ngIf="isVisible" [resizableColumns]="true" selectionMode="checkbox" [value]="dataFiles" (onNodeSelect) = "dataFileCount()" (onNodeUnselect) = "dataFileCount()" [(selection)]="selectedData" [scrollable]="true" scrollHeight="600px" [style]="{ 'padding-left':'3%','padding-right':'3%','padding-bottom':'3%', 'color':'#000'}"> -->
  <p-treeTable *ngIf="isVisible" [resizableColumns]="true" selectionMode="checkbox" [value]="dataFiles"
    (onNodeSelect)="dataFileCount()" (onNodeUnselect)="dataFileCount()" [(selection)]="selectedData"
    [style]="{ 'padding-left':'3%','padding-right':'3%','padding-bottom':'3%', 'color':'black'}">
    <ng-template pTemplate="header">
      <tr>
        <th style=" background-color: #1E6BA1; width:60%; color:white" ttResizableColumn>
          <span (click)="expandToLevel(dataFiles, !isExpanded, null)" style="padding-right:0.5em;">
            <i *ngIf="!isExpanded" class="faa faa-arrow-circle-down faa-1x icon-white"
              style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Expand All"></i>
            <i *ngIf="isExpanded" class="faa faa-arrow-circle-up faa-1x icon-white"
              style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Collapse All"></i>
          </span>
          <span (click)="showZipFilesNmaes = !showZipFilesNmaes" style="padding-right:0.5em;" *ngIf="zipData.length>0">
            <i *ngIf="!showZipFilesNmaes" class="faa faa-eye faa-1x icon-white"
              style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Show Zip Files"></i>
            <i *ngIf="showZipFilesNmaes" class="faa faa-eye-slash faa-1x icon-white"
              style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Hide Zip Files"></i>
          </span>
          Name
        </th>
        <th style=" background-color: #1E6BA1; color:white; width:10%;" ttResizableColumn>MediaType</th>
        <th style=" background-color: #1E6BA1; color:white; width:10%;" ttResizableColumn>Size</th>
        <th style=" background-color: #1E6BA1; color:white; width:20%;" ttResizableColumn>
          <i class="faa faa-recycle faa-1x icon-white" (click)="clearDownloadStatus()"
            style="cursor: pointer;color: rgb(255, 255, 255);padding-right:0.5em;" data-toggle="tooltip"
            title="Reset Download Status"></i>
          Download Status
        </th>
      </tr>
    </ng-template>
    <ng-template let-rowNode let-rowData="rowData" let-i="rowIndex" pTemplate="body">
      <tr style="background: #FFFFFF">
        <td style=" width:75%; ">
          <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
          &nbsp;<p-treeTableCheckbox [value]="rowNode"></p-treeTableCheckbox>
          <!-- <span *ngIf = "rowData.resTitle.indexOf('.') > 0 "> {{rowData.resTitle}} </span> -->
          <!-- &nbsp;<a href="{{rowData.downloadUrl}}" target="_blank" *ngIf = "rowData.resTitle.indexOf('.') > 0 "> -->
          <!-- </a> -->
          <span *ngIf="rowData.isLeaf">
            <a (click)="openDetails($event,rowData,op3) " style="color: #1E6BA1;cursor: pointer;" data-toggle="tooltip"
              title="Click for more details">
              {{rowData.resTitle}} </a>
          </span>
          <span *ngIf="!rowData.isLeaf">
            {{rowData.resTitle}}
          </span>
          <span *ngIf="showZipFilesNmaes" style="color:grey;margin-left: 1em;font-style: italic;">
            {{rowData.zipFile}}</span>
        </td>
        <td>
          <span>{{rowData.mediatype}}</span>
        </td>
        <td>
          <span>{{rowData.size}}</span>
        </td>
        <td>
          &nbsp;
          <!-- <span *ngIf = "rowData.resTitle.indexOf('.') > 0" (click)="downloadOneFile(rowData)"> -->
          <!-- <a href="{{rowData.downloadUrl}}" download>
            <i class="faa faa-download" [ngStyle]="{'color':getDownloadBtnColor(rowData)}" aria-hidden="true"
              (click)="setFileDownloaded(rowData)"></i>
          </a> -->

          <span *ngIf="rowData.isLeaf" (click)="downloadOneFile(rowData)">
            <i *ngIf="rowData.downloadStatus == null" class="faa faa-download" style="color: #1E6BA1;cursor: pointer;"
              aria-hidden="true" data-toggle="tooltip" title="Direct download"></i>
            <i *ngIf="rowData.downloadStatus === 'downloaded'" class="faa faa-download"
              style="color:green; cursor: pointer;" aria-hidden="true" data-toggle="tooltip" title="Download again"></i>
          </span>
          <div *ngIf="showDownloadProgress && rowData.downloadStatus === 'downloading'" style="display:flex;">
            <span style="display:inline;font-size: 0.8em">
              {{rowData.downloadProgress}}%
            </span>
            <div style="flex: 0 0 auto; width: 80px;padding-top: 3px">
              <p-progressBar [value]="rowData.downloadProgress" showValue="true"></p-progressBar>
            </div>
            <div style="padding-left:5px; flex: 0 0 auto;">
              <span (click)="cancelDownload(rowData)" style="cursor: pointer;"><i class="faa faa-remove"></i></span>
            </div>
          </div>

          <!-- <button type="button" *ngIf = "rowData.downloadStatus === 'downloaded' && rowData.resTitle.indexOf('.') > 0 " style="margin-left:-20px;margin-top: 5px;padding-left:.5em;" class="small-button" pButton icon="faa faa-check"></button>
                        <button type="button" *ngIf = "rowData.downloadStatus === 'downloading' && rowData.resTitle.indexOf('.') > 0 "  class="small-button-yellow" pButton icon="faa faa-check"></button> &nbsp; -->
          <!-- <span *ngIf = "rowData.resTitle.indexOf('.') > 0 && rowData.downloadStatus != 'downloading'" style="padding-left:0.5em;">{{rowData.downloadStatus}}</span> -->
          <span *ngIf="rowData.isLeaf && rowData.downloadStatus != 'downloading'"
            style="padding-left:0.5em;">{{rowData.downloadStatus}}</span>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td align="center" colspan="3">
          No records found
        </td>
      </tr>
    </ng-template>
  </p-treeTable>
</div>

<p-overlayPanel class="fileDialog" #op3 [dismissable]="true" [showCloseIcon]="true" [style]="{'display':'inline-block'}"
  [appendTo]="'body'">
  <div *ngIf="isNodeSelected" class="filecard">
    <div class="ui-g filesection">
      <div *ngIf="fileNode" class="ui-g-12 ui-md-12 ui-lg-12 ui-sm-10">
        <span class="font8" style="color:grey">
          <span *ngIf="fileNode.filetype == 'nrdp:DataFile' ">Selected File</span>
          <span *ngIf="fileNode.filetype == 'nrdp:ChecksumFile' ">Selected Checksum File</span>
          <span *ngIf="fileNode.filetype == 'nrdp:Subcollection'">Selected SubCollection </span>
          <br>
        </span>
        <span class="font14">{{ fileNode ? fileNode.resTitle : '' }}</span>
        <!-- <span *ngIf="fileNode.mediatype == 'nrdp:DataFile' " class="font8"> -->
        <span class="font8" style="color:grey">
          <br><b>Type:</b>
          <span style="margin-left:0.5em;" class="textstyle1">{{ fileNode.mediatype ? fileNode.mediatype : 'Not
            Available'}} </span>
        </span>
        <!-- <span *ngIf="fileNode.mediatype == 'nrdp:DataFile' " class="font8" style="margin-left: 2.5rem"> -->
        <span class="font8" style="margin-left: 2.5rem">
          Size:
          <span *ngIf="fileNode.size" class="textstyle1">{{ formatBytes(fileNode.size) }} </span>
          <span *ngIf="!fileNode.size" class="textstyle1"><i>Not Available</i></span>
        </span>
        <br><span class="font10"><b>Description:</b> </span>
        <div class="well filedesc">
          <span *ngIf="!fileNode.description"><i>No Description Available</i></span>
          <span *ngIf="fileNode.description">{{ fileNode.description }} </span>
        </div>
      </div>
    </div>
  </div>
</p-overlayPanel>