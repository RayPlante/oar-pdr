<div id="title">Download Manager</div>
<div id="current-task" *ngIf="showCurrentTask">
    <div id="current-task-detail">
        <p-progressSpinner [style]="{'width': '25px', 'height': '25px', 'padding-right':'0.5em', 'padding-top': '0em'}">
        </p-progressSpinner>
        {{currentTask}}
    </div>
</div>

<!-- Display message returned from bundle plan if any -->
<div class="full-span">
    <div style="justify-content: space-between;">
        <div *ngIf="bundlePlanStatus != 'complete' && bundlePlanMessage" class="title-line">
            <!-- Icon button to show/hide bundle message details -->
            <span *ngIf="bundlePlanStatus != 'internal error'" (click)="showMessageBlock = !showMessageBlock">
                <i *ngIf="!showMessageBlock" class="faa faa-arrow-circle-down"
                    [ngStyle]="{'color':messageColor,'cursor':'pointer','margin':'0 .5em'}" data-toggle="tooltip"
                    title="Show details"></i>
                <i *ngIf="showMessageBlock" class="faa faa-arrow-circle-up faa-1x icon-white"
                    [ngStyle]="{'color':messageColor,'cursor':'pointer','margin':'0 .5em'}" data-toggle="tooltip"
                    title="Hide details"></i>
            </span>
            <span *ngIf="bundlePlanStatus == 'internal error';else no_error" [ngStyle]="{'color':messageColor}">
                Ooops! There was a problem getting the data you need. Please contact us at <a
                    href="mailto:datasupport@nist.gov?subject={{emailSubject}}&body={{emailBody}}"
                    (click)="gaService.gaTrackEvent('Email', $event, 'AskHelp', 'mailto:datasupport@nist.gov')">datasupport@nist.gov</a>
                to report the problem. If possible, include the string "PDR: Error getting download plan" in your email
                report.</span>
            <ng-template #no_error>
                <span [ngStyle]="{'color':getColor(), 'padding-right':'.5em'}">{{broadcastMessage}}</span>
                <span *ngIf="bundlePlanStatus == 'error'">
                    For tech support, please email <a
                        href="mailto:datasupport@nist.gov?subject={{emailSubject}}&body={{emailBody}}"
                        (click)="gaService.gaTrackEvent('Email', $event, 'AskHelp', 'mailto:datasupport@nist.gov')">datasupport@nist.gov
                        <i class="faa faa-envelope" data-toggle="tooltip" title="Email tech support"></i></a>
                </span>
            </ng-template>
        </div>
    </div>
</div>

<!-- Display bundle message details -->
<div class="full-span" *ngIf="showMessageBlock">
    <div class="header-orange" data-toggle="tooltip" title="Bundle message details">
        <span style="margin-left: .5em;" *ngIf="bundlePlanMessage" (click)="showMessage = !showMessage">
            <i *ngIf="showMessage; else hideMessage" class="faa faa-arrow-circle-up faa-1x icon-white"
                style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Collapse All"></i>
            <ng-template #hideMessage>
                <i class="faa faa-arrow-circle-down faa-1x icon-white"
                    style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Expand All"></i>
            </ng-template>
        </span>
        Message
    </div>
    <div *ngIf="showMessage">
        <div class="underline" style="padding-left:.5em;margin-bottom: .5em;" *ngFor="let msg of bundlePlanMessage; let i =index">
            {{msg}}
        </div>
    </div>

    <!-- Show unhandled files if any -->
    <!-- header -->
    <div class="header-orange" data-toggle="tooltip" title="Unhandled Files">
        <span class="span30">
            <span *ngIf="bundlePlanUnhandledFiles" (click)="showUnhandledFiles = !showUnhandledFiles">
                <i *ngIf="showUnhandledFiles; else hideUnhandledFiles" class="faa faa-arrow-circle-up faa-1x icon-white"
                    style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Collapse All"></i>
                <ng-template #hideUnhandledFiles>
                    <i class="faa faa-arrow-circle-down faa-1x icon-white"
                        style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Expand All"></i>
                </ng-template>
            </span>
            File Path
        </span>
        <span class="span30">Download Url</span>
        <span class="span-end" style="width: 35%;">Detail message</span>
    </div>
    <!-- body -->
    <div class="unhandled-files" *ngIf="showUnhandledFiles">
        <div class="underline" style="width: 100%;" *ngFor="let file of bundlePlanUnhandledFiles">
            <span class="span30">{{file.filePath}}</span>
            <span class="span30">{{file.downloadUrl}}</span>
            <span class="span-end" style="width: 30%;">{{file.message}}</span>
        </div>
    </div>
</div>

<!-- Display zip files if any -->
<!-- header -->
<div class="full-span">
    <div *ngIf="zipData.length > 0 && showMessageBlock" class="header-green" style="width: 100%;" data-toggle="tooltip"
        title="Zip Files">
        <span class="span30">
            <!-- Toggle button to show/hide zip files-->
            <span (click)="showZipFiles = !showZipFiles">
                <i *ngIf="!showZipFiles" class="faa faa-arrow-circle-down faa-1x icon-white"
                    style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Expand All"></i>
                <i *ngIf="showZipFiles" class="faa faa-arrow-circle-up faa-1x icon-white"
                    style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip" title="Collapse All"></i>
            </span>
            Zip File Name
        </span>
        Download Status
        <span class="span-end" *ngIf="!allProcessed" class="faa-stack fa-lg"
            style="cursor: pointer; display: inline-block;" (click)="cancelDownloadAll()" data-toggle="tooltip"
            title="Cancel All Downloads">
            <i class="faa faa-remove faa-stack-1x" aria-hidden="true" style="color: rgb(255, 255, 255);"></i>
        </span>
    </div>
    <!-- body -->
    <div class="unhandled-files" *ngIf="showZipFiles && showMessageBlock">
        <div class="underline" style="width: 100%;" *ngFor="let zip of zipData">
            <span class="span30">{{zip.fileName}}</span>
            <span class="span-end">
                <div style="display:inline-block;" *ngIf="zip.downloadStatus === 'downloading';else not_downloading">
                    <span style="display:inline-block;padding-left: .5em;">
                        <p-progressSpinner [style]="{width: '12px', height: '12px'}"></p-progressSpinner>
                    </span>
                    <span style="display:inline-block;margin-left: 0.5em;">
                        {{zip.downloadStatus}}
                    </span>
                    <span (click)="cancelDownloadZip(zip)"
                        style="display:inline-block;cursor: pointer;padding-left:5px;"><i
                            class="faa faa-remove"></i></span>
                </div>
                <ng-template #not_downloading>
                    <div *ngIf="zip.downloadStatus != 'error'; else download_error" style="display:inline-block;">
                        <i *ngIf="zip.downloadStatus === 'downloaded'" class="faa faa-check"
                            style="margin-top: 8px;"></i>
                        <i *ngIf="zip.downloadStatus === 'cancelled'" class="faa faa-remove"
                            style="margin-top: 8px;"></i>
                        {{zip.downloadStatus}}
                    </div>
                    <ng-template #download_error>
                        <div style="display:inline-block;margin-left: .5em;font-size: 0.8em; color: red">
                            <i class="faa faa-warning"
                                [ngStyle]="{'color':messageColor, 'padding-right':'.5em', 'margin-top':'8px'}"></i>
                            {{zip.downloadErrorMessage}}
                        </div>
                    </ng-template>
                    <i *ngIf="zip.downloadStatus != null" class="faa faa-repeat"
                        style="display: inline-block; margin-left: .5em; font-size: 0.8em; color: #1E6BA1; cursor: pointer;"
                        data-toggle="tooltip" title="Retry" (click)="downloadOneZip(zip)"></i>
                </ng-template>
            </span>
        </div>
    </div>
</div>
<!-- Control buttons -->
<div style="padding-left: 3%; padding-right: 3%; width: 100%;margin-bottom:0.5em;text-align: right;">
    <button type="button" (click)="downloadAllFilesFromAPI()" pButton type="submit"
        [ngStyle]="{'margin-right':'1em','width':'max-content','height':'2.5em','background-color':getButtonColor()}"
        [disabled]="selectedFileCount==0">
        <i class="faa faa-download faa-1x icon-white" style="color: #fff;"></i>
        Download Selected
        <span class="w3-circle button-badge"
            [ngStyle]="{'color':getButtonColor()}">&nbsp;{{selectedFileCount}}&nbsp;</span>
    </button>

    <button type="button" (click)="removeByDownloadStatus()" pButton type="submit"
        style="margin-right:1em;width:max-content; height:2.5em; background-color:rgb(82, 82, 82);"
        [disabled]="noFileDownloaded">
        <i class="faa faa-trash faa-1x icon-white" style="color: #fff;"></i>
        Remove downloaded
        <span class="w3-circle button-badge"
            [ngStyle]="{'color':getDownloadedColor(),'background-color':getDownloadedBkColor()}">&nbsp;{{totalDownloaded}}&nbsp;</span>
    </button>

    <button type="button" (click)="removeByDataId()" pButton type="submit"
        style="width:max-content; height:2.5em; background-color:rgb(82, 82, 82);" [disabled]="selectedFileCount==0">
        <i class="faa faa-trash faa-1x icon-white" style="color: #fff;"></i>
        Remove selected
        <span class="w3-circle button-badge"
            [ngStyle]="{'color':'rgb(82, 82, 82)'}">&nbsp;{{selectedFileCount}}&nbsp;</span>
    </button>
</div>

<!-- Display data file tree table -->
<div>
    <p-treeTable *ngIf="isVisible" [resizableColumns]="true" selectionMode="checkbox" [value]="dataFiles"
        (onNodeSelect)="dataFileCount()" (onNodeUnselect)="dataFileCount()" [(selection)]="selectedData"
        [style]="{ 'padding-left':'3%','padding-right':'3%','padding-bottom':'3%', 'color':'black'}">
        <ng-template pTemplate="header">
            <tr>
                <th [ngStyle]="titleStyleHeader()" ttResizableColumn>
                    <span (click)="expandToLevel(dataFiles, !isExpanded, null)" style="padding-right:0.5em;">
                        <i *ngIf="!isExpanded" class="faa faa-arrow-circle-down faa-1x icon-white"
                            style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip"
                            title="Expand All"></i>
                        <i *ngIf="isExpanded" class="faa faa-arrow-circle-up faa-1x icon-white"
                            style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip"
                            title="Collapse All"></i>
                    </span>
                    <span (click)="showZipFilesNmaes = !showZipFilesNmaes" style="padding-right:0.5em;"
                        *ngIf="zipData.length>0">
                        <i *ngIf="!showZipFilesNmaes" class="faa faa-eye faa-1x icon-white"
                            style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip"
                            title="Show Zip Files"></i>
                        <i *ngIf="showZipFilesNmaes" class="faa faa-eye-slash faa-1x icon-white"
                            style="cursor: pointer;color: rgb(255, 255, 255);" data-toggle="tooltip"
                            title="Hide Zip Files"></i>
                    </span>
                    Name
                </th>
                <th [ngStyle]="typeStyleHeader()" ttResizableColumn>Media Type</th>
                <th [ngStyle]="sizeStyleHeader()" ttResizableColumn>Size</th>
                <th [ngStyle]="statusStyleHeader()" ttResizableColumn>
                    <i class="faa faa-recycle faa-1x icon-white" (click)="clearDownloadStatus()"
                        style="cursor: pointer;color: rgb(255, 255, 255);padding-right:0.5em;" data-toggle="tooltip"
                        title="Reset Download Status"></i>
                    Status
                </th>
            </tr>
        </ng-template>
        <ng-template let-rowNode let-rowData="rowData" let-i="rowIndex" pTemplate="body">
            <tr style="background: #FFFFFF">
                <td [ngStyle]="titleStyle()">
                    <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
                    &nbsp;<p-treeTableCheckbox [value]="rowNode"></p-treeTableCheckbox>
                    <span *ngIf="rowData.isLeaf">
                        <a (click)="openDetails($event,rowData,op3) " style="color: #1471AE; cursor: pointer;"
                            data-toggle="tooltip" title="Click for more details">
                            {{rowData.resTitle}} </a>
                    </span>
                    <span *ngIf="!rowData.isLeaf">
                        {{rowData.resTitle}}
                    </span>
                    <span *ngIf="showZipFilesNmaes" style="color:grey;margin-left: 1em;font-style: italic;">
                        {{rowData.zipFile}}</span>
                </td>
                <td [ngStyle]="typeStyle()">
                    <span>{{rowData.mediatype}}</span>
                </td>
                <td [ngStyle]="sizeStyle()">
                    <span *ngIf="rowData.isLeaf">{{formatBytes(rowData.fileSize)}}</span>
                </td>
                <td [ngStyle]="statusStyle()">
                    <div *ngIf="rowData.isLeaf;else space_holder" style="display:inline;">
                        <a *ngIf="rowData.downloadStatus != 'downloading'" href='{{rowData.downloadUrl}}'
                            target='_blank' download="download" data-toggle="tooltip" title="Direct download"
                            aria-label="Direct download">
                            <i class="faa faa-download" [ngStyle]="{'color':getDownloadBtnColor(rowData)}"
                                aria-hidden="true" (click)="setFileDownloaded(rowData)"></i>
                        </a>
                    </div>
                    <ng-template #space_holder>
                        <div style="display:inline;padding-right: 0.4em;">&nbsp;&nbsp;</div>
                    </ng-template>
                    <div id="downloadstatus" *ngIf="rowData.isLeaf && rowData.downloadStatus != 'downloading'"
                        style="display:inline;">
                        {{rowData.downloadStatus}}
                    </div>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td align="center" colspan="3">
                    No records found
                </td>
            </tr>
        </ng-template>
    </p-treeTable>
</div>

<!-- Popup dialog for file details -->
<p-overlayPanel class="fileDialog" #op3 [dismissable]="true" [showCloseIcon]="true"
    [style]="{'display':'inline-block','position':'related','left':'50%','top':'80%'}" appendToBody=true>
    <div *ngIf="isNodeSelected" class="filecard" [ngStyle]="{'max-width':getDialogWidth()}">
        <div class="ui-g filesection">
            <div *ngIf="fileNode" class="ui-g-12 ui-md-12 ui-lg-12 ui-sm-10">
                <span class="font8" style="color:grey">
                    <span *ngIf="fileNode.filetype == 'nrdp:DataFile' ">Selected File</span>
                    <span *ngIf="fileNode.filetype == 'nrdp:ChecksumFile' ">Selected Checksum File</span>
                    <span *ngIf="fileNode.filetype == 'nrdp:Subcollection'">Selected SubCollection </span>
                    <br>
                </span>
                <span class="font14">{{ fileNode ? fileNode.resTitle : '' }}</span>
                <span class="font8" style="color:grey">
                    <br><b>Type:</b>
                    <span style="margin-left:0.5em;" class="textstyle1">{{ fileNode.mediatype ? fileNode.mediatype : 'Not
            Available'}} </span>
                </span>
                <span class="font8" style="margin-left: 2.5rem">
                    Size:
                    <span *ngIf="fileNode.size" class="textstyle1">{{ formatBytes(fileNode.size) }} </span>
                    <span *ngIf="!fileNode.size" class="textstyle1"><i>Not Available</i></span>
                </span>
                <br><span class="font10"><b>Description:</b> </span>
                <div class="well filedesc">
                    <span *ngIf="!fileNode.description"><i>No Description Available</i></span>
                    <span *ngIf="fileNode.description">{{ fileNode.description }} </span>
                </div>
            </div>
        </div>
    </div>
</p-overlayPanel>